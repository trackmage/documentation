"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[988],{8728:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return p},toc:function(){return d},default:function(){return u}});var o=n(7462),a=n(3366),r=(n(7294),n(3905)),i=["components"],s={id:"Webhooks",title:"Webhooks Guide",sidebar_label:"Webhooks",slug:"webhooks.html"},l=void 0,p={unversionedId:"workflow/Webhooks",id:"workflow/Webhooks",title:"Webhooks Guide",description:"With webhooks you can receive updates about particular entities.",source:"@site/docs/workflow/Webhooks.mdx",sourceDirName:"workflow",slug:"/workflow/webhooks.html",permalink:"/docs/workflow/webhooks.html",tags:[],version:"current",frontMatter:{id:"Webhooks",title:"Webhooks Guide",sidebar_label:"Webhooks",slug:"webhooks.html"},sidebar:"mainSidebar",previous:{title:"Workflow",permalink:"/docs/workflow/workflow.html"},next:{title:"Custom Fields",permalink:"/docs/custom-fields.html"}},d=[{value:"How to setup the Webhooks",id:"how-to-setup-the-webhooks",children:[],level:2},{value:"Securing Webhooks",id:"securing-webhooks",children:[],level:2},{value:"Frequency of updates and Concurrency",id:"frequency-of-updates-and-concurrency",children:[],level:2},{value:"Anatomy of Webhook",id:"anatomy-of-webhook",children:[],level:2},{value:"List of supported webhook entities and events",id:"list-of-supported-webhook-entities-and-events",children:[],level:2},{value:"What you can do with Webhook via API",id:"what-you-can-do-with-webhook-via-api",children:[{value:"How to programmatically create webhook",id:"how-to-programmatically-create-webhook",children:[],level:3},{value:"How to programmatically delete webhook",id:"how-to-programmatically-delete-webhook",children:[],level:3}],level:2},{value:"How to handle webhook updates",id:"how-to-handle-webhook-updates",children:[],level:2}],h={toc:d};function u(e){var t=e.components,n=(0,a.Z)(e,i);return(0,r.kt)("wrapper",(0,o.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"With webhooks you can receive updates about particular entities.\nAfter you subscribed to a webhook you'll be receiving events when the entity is created, updated or deleted."),(0,r.kt)("p",null,"For example, you can rely on webhooks to trigger an action in your app when an order is created, or when tracking status of shipment is updated.\nBy using webhooks subscriptions you can make fewer API calls overall, which makes sure that your apps are more efficient and update quickly."),(0,r.kt)("p",null,"You can view this ",(0,r.kt)("a",{parentName:"p",href:"https://www.youtube.com/watch?v=rxjkoeN0uMs"},"video")," to better understand how webhooks work in TrackMage."),(0,r.kt)("h2",{id:"how-to-setup-the-webhooks"},"How to setup the Webhooks"),(0,r.kt)("p",null,"You can enable the webhook from the Automation / Webhooks page in the ",(0,r.kt)("a",{parentName:"p",href:"https://app.trackmage.com/"},"TrackMage admin panel")," --\x3e Add webhook --\x3e Enter Webhook URL -> Select entities and events to start receiving updates."),(0,r.kt)("h2",{id:"securing-webhooks"},"Securing Webhooks"),(0,r.kt)("p",null,"We currently support either HTTP or HTTPS URLs, so you can have security by using an SSL-enabled URL.\nTo restrict access for your webhook endpoint we allow use two types of authorization:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Basic")," - an HTTP authentication using username and password."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Bearer")," - an HTTP authentication scheme that involves security tokens called bearer tokens.")),(0,r.kt)("h2",{id:"frequency-of-updates-and-concurrency"},"Frequency of updates and Concurrency"),(0,r.kt)("p",null,"For each webhook you can set up frequency of updates."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Immediately"),": the update will be sent as soon as a tracking number status changes."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"5 minutes - 6 hours"),": Webhook accumulates the updates and will send them in a batch.")),(0,r.kt)("p",null,"How Concurrency works:",(0,r.kt)("br",null),"\nLet's say, in the webhook buffer there are 1500 tracking numbers. Before the sending, the buffer is always split into portions or batches. The number of requests depends on the amount of tracking numbers to send and on the batch size. Currently, the batch size is 500.\nThe webhook buffer gets empty on success response. If response status is an error (4xx, 5xx), the tracking numbers will remain in the queue. If the response status is 401 - the webhook will be disabled.\nPartially submitted data will not be submitted again. For example, if webhook was able to submit 500 tracking numbers out of 1000, on the next call it will submit only remaining 500 (not 1000 like it used to)."),(0,r.kt)("p",null,"Example 1. The concurrency is set to 1 (or none)."),(0,r.kt)("p",null,"The batches will be sent consequently, so requests will not be sent in parallel.\nThe next batch will be sent only after the response from the previous has been received. In case if response status is error it'll stop sending the others."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[500][500][500] => receiver\n")),(0,r.kt)("p",null,"Example 2. The concurrency is 3 and all requests are sent in parallel."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[500]\n[500] => receiver\n[500]\n")),(0,r.kt)("p",null,"On error, it will not stop but will try to send the next request. At the end, all not-accepted requests will be scheduled for the next webhook call."),(0,r.kt)("h2",{id:"anatomy-of-webhook"},"Anatomy of Webhook"),(0,r.kt)("p",null,"After you configure a webhook subscription, the events that you specified will schedule or send immediately (depended on your webhook settings)\na webhook notification.\nTrackMage sends event driven data to webhook URL via POST method.\nThis notification contains a JSON payload with event data and authorization header (basic or bearer) if Auth Type is set in the webhook settings."),(0,r.kt)("p",null,"JSON payload is represented by list of objects with four properties:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},'"entity"'),"- the entity for which the webhook triggered"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},'"event"')," - the event type create/update/delete"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},'"data"')," - the entity's data"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},'"updatedFields"')," - the list of updated fields codes (empty for create/delete events)")),(0,r.kt)("p",null,"For example, the shipments/update webhook contains:"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Header")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"authorization: Basic eDE6eDI=\ncontent-length: 1007\ncontent-type: application/json\nhost: webhook.example.com\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Body")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "data": [\n    {\n      "entity": "shipments",\n      "data": {\n        "id": "018c7b7f-91d9-442d-ade4-eb72f95b9c15",\n        "@id": "/shipments/018c7b7f-91d9-442d-ade4-eb72f95b9c15",\n        "@type": "Shipment",\n        "email": null,\n        ...\n        "@context": "/contexts/Shipment",\n        "createdAt": "2021-05-05T09:01:26+02:00",\n        "shippedAt": "2021-05-02T07:01:27+00:00",\n        "updatedAt": "2021-05-05T07:01:27+00:00",\n        ...\n      },\n      "event": "update",\n      "updatedFields": [\n        "trackingStatus",\n        "destinationCarrier",\n        ...\n      ]\n    },\n    {\n      "entity": "shipments",\n      "data": {\n        "id": "018c7b7f-91d9-442d-ade4-eb72f95b9c15",\n        "@id": "/shipments/018c7b7f-91d9-442d-ade4-eb72f95b9c15",\n        "@type": "Shipment",\n        "email": null,\n        ...\n        "@context": "/contexts/Shipment",\n        "createdAt": "2021-05-05T09:01:26+02:00",\n        "shippedAt": null,\n        "updatedAt": "2021-05-05T07:01:27+00:00",\n        ...\n      },\n      "event": "update",\n      "updatedFields": [\n        "originCarrier",\n        "handler",\n        "updatedAt"\n      ]\n    }\n  ]\n}\n')),(0,r.kt)("h2",{id:"list-of-supported-webhook-entities-and-events"},"List of supported webhook entities and events"),(0,r.kt)("p",null,"TrackMage allows to create one webhook for all supported entities and events.\nBut we recommend specifying separate webhooks for different entities and events."),(0,r.kt)("p",null,"Webhooks are available for the following entities:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("a",{parentName:"strong",href:"/docs/shipment/shipment.html"},"Shipment"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("a",{parentName:"strong",href:"/docs/shipment/shipment-item.html"},"ShipmentItem"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("a",{parentName:"strong",href:"/docs/order/order.html"},"Order"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("a",{parentName:"strong",href:"/docs/order/order-item.html"},"OrderItem"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Reviews"))),(0,r.kt)("p",null,"Webhooks can be triggered for the following events:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"create")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"update")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"delete"))),(0,r.kt)("h2",{id:"what-you-can-do-with-webhook-via-api"},"What you can do with Webhook via API"),(0,r.kt)("p",null,"Webhooks are represented by ",(0,r.kt)("a",{parentName:"p",href:"/docs/workflow/workflow.html"},"Workflow")," entity in the TrackMage API."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"In API request you should use ",(0,r.kt)("inlineCode",{parentName:"p"},'type: "webhook"')," to be sure you work with webhook"))),(0,r.kt)("p",null,"In addition to standard ",(0,r.kt)("a",{parentName:"p",href:"/docs/workflow/workflow.html#workflow-properties"},"Workflow fields"),", webhook has its own specified properties, which should be used in API requests.\nA full list of specified properties can be retrieved by using request to ",(0,r.kt)("a",{parentName:"p",href:"/docs/custom-fields.html#getFieldCollection"},"Custom Fields")," endpoint with GET parameter ",(0,r.kt)("inlineCode",{parentName:"p"},"entity=workflows.webhook"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-curl"},"https://api.trackmage.com/fields?entity=workflows.webhook\n")),(0,r.kt)("p",null,"Full list of available endpoints to create/update/edit webhooks available on the ",(0,r.kt)("a",{parentName:"p",href:"/docs/workflow/workflow.html#endpoints"},"workflow")," page."),(0,r.kt)("h3",{id:"how-to-programmatically-create-webhook"},"How to programmatically create webhook"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"\n<?php\nuse TrackMage\\Client\\TrackMageClient;\n\ntry {\n    $response = $client->post('/workflows', ['json' => [\n        'type' => 'webhook',\n        'period' => 'immediately',\n        'event' => 'update',\n        'title' => 'test webhook', // webhook title\n        'concurrency' => '1',\n        'workspace' => '/workspaces/' . $workspaceId,\n        'url' => $targetUrl,\n        'enabled' => true,\n        'entity' => $entity, // shipments|shipment_items|orders|order_items or null for any\n        'event' => $event, // create|update|delete or null for any\n        'field' => $field, // any field or null for any\n    ]]);\n    $data = TrackMageClient::item($response);\n} catch( ClientException $e ) {\n    print('Unable to create webhook: '.TrackMageClient::error($e));\n}\n")),(0,r.kt)("h3",{id:"how-to-programmatically-delete-webhook"},"How to programmatically delete webhook"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"\n<?php\nuse TrackMage\\Client\\TrackMageClient;\n\ntry {\n    $response = $client->delete('/workflows/'.$webhookId);\n} catch( ClientException $e ) {\n    print('Unable to delete webhook: '.TrackMageClient::error($e));\n}\n")),(0,r.kt)("h2",{id:"how-to-handle-webhook-updates"},"How to handle webhook updates"),(0,r.kt)("p",null,"This example shows you how to retrieve the webhook, validate Basic authentication it and save data to a CSV file."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"\n<?php\n\nvalidateAuth('trackmage', 'QwYDLKEYPWBoj74T2');\n$trackings = extractTrackingsFromRequest();\n$filename = extractFilenameFromRequest();\nsaveTrackingsToFile($trackings, __DIR__.'/'.$filename.'.csv');\nprint count($trackings).\" items processed\";\n\nfunction validateAuth($allowedLogin, $allowedPassword) {\n    if (!isset($_SERVER['PHP_AUTH_USER']) || !isset($_SERVER['PHP_AUTH_PW']) ||\n        $_SERVER['PHP_AUTH_USER'] !== $allowedLogin || $_SERVER['PHP_AUTH_PW'] !== $allowedPassword\n    ) {\n        header('WWW-Authenticate: Basic realm=\"Restricted area\"');\n        http_response_code(401);\n        print 'Unauthorized ' . $_SERVER['REQUEST_URI'] . \" from \" . $_SERVER['REMOTE_ADDR'];\n        exit;\n    }\n}\n\nfunction extractFilenameFromRequest() {\n  $host = $_SERVER['HTTP_HOST'];\n  if (false === $pos = strpos($host, 'trackmagic-webhook.your-domain.com')) {\n    return 'trackings-log';\n  }\n  return substr($host, 0, $pos-1);\n}\n\nfunction extractTrackingsFromRequest() {\n    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {\n        http_response_code(400);\n        print 'Request method must be POST';\n        exit;\n    }\n    $json = file_get_contents('php://input');\n    $data = @json_decode($json, true);\n    if (is_null($data) || !isset($data['data'])) {\n        http_response_code(400);\n        print 'Bad json format';\n        exit;\n    }\n    return $data['data'];\n}\n\nfunction saveTrackingsToFile(array $trackings, $filename) {\n    $file = new SplFileObject($filename, 'a');\n    $timestamp = (new DateTime())->format('c');\n    foreach ($trackings as $tracking) {\n        $file->fputcsv([\n            $timestamp,\n            $tracking['trackingNumber'],\n            $tracking['status'],\n        ]);\n    }\n}\n\n")))}u.isMDXComponent=!0}}]);